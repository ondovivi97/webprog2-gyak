// REGISZTRÁCIÓ POST
app.post('/regisztracio', async (req, res) => {
    const { nev, email, jelszo, jelszo2 } = req.body;
    const errors = [];

    // ... (validálások)

    try {
        // email → username
        const [existing] = await db.query(
            'SELECT id FROM users WHERE username = ?',
            [email]
        );

        if (existing.length > 0) {
            errors.push('Ezzel az e-mail címmel már regisztráltak.');
            return res.render('regisztracio', {
                title: 'Regisztráció',
                errors,
                values: { nev, email }
            });
        }

        const hashedPassword = await bcrypt.hash(jelszo, 10);

        await db.query(
            'INSERT INTO users (username, password, role) VALUES (?, ?, ?)',
            [email, hashedPassword, 'user']
        );

        req.flash('success', 'Sikeres regisztráció! Most jelentkezz be.');
        res.redirect('/login');

    } catch (err) {
        console.error('Regisztráció hiba:', err);
        res.render('regisztracio', {
            title: 'Regisztráció',
            errors: ['Szerverhiba történt, próbáld meg később.'],
            values: { nev, email }
        });
    }
});
